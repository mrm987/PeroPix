name: Build and Release
on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  # 패치 파일 생성 (Windows/macOS 공통)
  create-patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 전체 히스토리 필요 (이전 태그 비교용)

      - name: Get previous tag
        id: prev-tag
        run: |
          # 현재 태그 제외하고 가장 최근 태그 찾기
          CURRENT_TAG="${{ github.event.release.tag_name }}"
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${CURRENT_TAG}$" | head -n 1)
          if [ -z "$PREV_TAG" ]; then
            # 첫 릴리즈인 경우 첫 커밋 사용
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Check if pip update required
        id: check-reinstall
        run: |
          PREV_TAG="${{ steps.prev-tag.outputs.prev_tag }}"

          # 직전 릴리즈와의 변경 확인
          CHANGED_FILES=$(git diff --name-only $PREV_TAG HEAD 2>/dev/null || echo "")
          echo "Changed files since $PREV_TAG:"
          echo "$CHANGED_FILES"

          # requirements 변경은 pip update 필요
          if echo "$CHANGED_FILES" | grep -qE "^requirements.*\.txt$"; then
            echo "requires_pip_update=true" >> $GITHUB_OUTPUT
            echo "Pip update required: requirements changed in this release"
            MIN_VERSION="1.0.0"  # pip update는 모든 버전에서 가능
            echo "min_version=$MIN_VERSION" >> $GITHUB_OUTPUT
          else
            echo "requires_pip_update=false" >> $GITHUB_OUTPUT
            echo "Hotfix possible: no requirements changes"
            # 모든 버전에서 패치 가능 (pip update 없이 코드만 교체)
            MIN_VERSION="1.0.0"
            echo "min_version=$MIN_VERSION" >> $GITHUB_OUTPUT
            echo "Min patchable version: $MIN_VERSION"
          fi

      - name: Generate version.json for patch
        run: |
          VERSION="1.0.0"
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          fi
          BUILD_DATE=$(date +%Y-%m-%d)
          cat > version.json << EOF
          {
            "version": "$VERSION",
            "build_date": "$BUILD_DATE"
          }
          EOF

      - name: Create patch-info.json
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          REQUIRES_PIP_UPDATE="${{ steps.check-reinstall.outputs.requires_pip_update }}"
          MIN_VERSION="${{ steps.check-reinstall.outputs.min_version }}"

          # 패치 대상 파일 목록 (항상 동일)
          cat > patch-info.json << EOF
          {
            "version": "$VERSION",
            "requires_pip_update": $REQUIRES_PIP_UPDATE,
            "min_version": "$MIN_VERSION",
            "files": [
              "index.html",
              "backend.py",
              "version.json",
              "PeroPix.bat",
              "requirements-core.txt"
            ],
            "folders": [
              "prompts",
              "assets",
              "scripts",
              "data",
              "local_engine",
              "models/censor"
            ]
          }
          EOF
          echo "Generated patch-info.json:"
          cat patch-info.json

      - name: Create patch-files.zip
        run: |
          mkdir -p patch-files

          # 핵심 파일 복사
          cp index.html patch-files/
          cp backend.py patch-files/
          cp version.json patch-files/
          cp PeroPix.bat patch-files/ 2>/dev/null || true
          cp requirements-core.txt patch-files/

          # 폴더 복사
          cp -r prompts patch-files/
          cp -r assets patch-files/
          cp -r scripts patch-files/
          cp -r data patch-files/
          cp -r local_engine patch-files/
          mkdir -p patch-files/models/censor
          cp models/censor/* patch-files/models/censor/ 2>/dev/null || true

          # ZIP 생성
          cd patch-files
          zip -r ../patch-files.zip .
          cd ..

          echo "Patch files created:"
          unzip -l patch-files.zip | head -30

      - name: Upload patch artifacts
        uses: actions/upload-artifact@v4
        with:
          name: patch-files
          path: |
            patch-info.json
            patch-files.zip
          retention-days: 1

  build-windows:
    needs: create-patch
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Embedded Python
        shell: pwsh
        run: |
          $pythonUrl = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          Invoke-WebRequest -Uri $pythonUrl -OutFile python-embed.zip
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/python"
          Expand-Archive -Path python-embed.zip -DestinationPath "dist/PeroPix/python"
          $pthFile = "dist/PeroPix/python/python311._pth"
          $content = Get-Content $pthFile
          $content = $content -replace '#import site', 'import site'
          Set-Content $pthFile $content
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & "dist/PeroPix/python/python.exe" get-pip.py --no-warn-script-location
      - name: Install Dependencies
        shell: pwsh
        run: |
          $pythonExe = "dist/PeroPix/python/python.exe"
          & $pythonExe -m pip install --no-warn-script-location -r requirements-core.txt
      - name: Fix OpenCV Config
        shell: pwsh
        run: |
          $cv2Dir = "dist/PeroPix/python/Lib/site-packages/cv2"
          if (Test-Path $cv2Dir) {
            $configContent = @"
          import os
          LOADER_DIR = os.path.dirname(os.path.abspath(__file__))
          PYTHON_EXTENSIONS_PATHS = [LOADER_DIR]
          BINARIES_PATHS = [LOADER_DIR]
          "@
            Set-Content -Path "$cv2Dir/config.py" -Value $configContent
            Set-Content -Path "$cv2Dir/config-3.py" -Value $configContent
            Write-Host "OpenCV config files created"
          }
      - name: Generate version.json
        shell: pwsh
        run: |
          $version = "1.0.0"
          if ("${{ github.event_name }}" -eq "release") {
            $version = "${{ github.event.release.tag_name }}" -replace '^v', ''
          }
          $buildDate = Get-Date -Format "yyyy-MM-dd"
          $json = @{
            version = $version
            build_date = $buildDate
          } | ConvertTo-Json
          Set-Content -Path "version.json" -Value $json -Encoding UTF8
          Write-Host "Generated version.json: $json"
      - name: Prepare Release Package
        shell: pwsh
        run: |
          Copy-Item "backend.py" -Destination "dist/PeroPix/"
          Copy-Item "index.html" -Destination "dist/PeroPix/"
          Copy-Item "version.json" -Destination "dist/PeroPix/"
          Copy-Item "PeroPix.bat" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "prompts" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "assets" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "scripts" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "data" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "local_engine" -Destination "dist/PeroPix/"
          # Note: python folder is already created in dist/PeroPix/python by "Download Embedded Python" step
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/censor"
          Copy-Item "models/censor/*" -Destination "dist/PeroPix/models/censor/"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/checkpoints"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/loras"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/upscale_models"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/outputs"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/presets"
          Copy-Item "README.md" -Destination "dist/PeroPix/" -ErrorAction SilentlyContinue
          Copy-Item "LICENSE" -Destination "dist/PeroPix/" -ErrorAction SilentlyContinue
      - name: Create ZIP Archive
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/PeroPix/*" -DestinationPath "PeroPix-Windows.zip"
      - name: Download patch artifacts
        if: github.event_name == 'release'
        uses: actions/download-artifact@v4
        with:
          name: patch-files
          path: ./patch-artifacts

      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            PeroPix-Windows.zip
            ./patch-artifacts/patch-info.json
            ./patch-artifacts/patch-files.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: PeroPix-Windows
          path: PeroPix-Windows.zip
          retention-days: 7

  build-macos:
    needs: create-patch
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Create Package Structure
        run: |
          mkdir -p dist/PeroPix/python
          curl -L -o python.tar.gz "https://github.com/indygreg/python-build-standalone/releases/download/20240415/cpython-3.11.9+20240415-aarch64-apple-darwin-install_only.tar.gz"
          tar -xzf python.tar.gz -C dist/PeroPix/python --strip-components=1
      - name: Install Dependencies
        run: |
          dist/PeroPix/python/bin/python3 -m pip install --upgrade pip
          dist/PeroPix/python/bin/python3 -m pip install -r requirements-core.txt
      - name: Fix OpenCV Config
        run: |
          CV2_DIR="dist/PeroPix/python/lib/python3.11/site-packages/cv2"
          if [ -d "$CV2_DIR" ]; then
            cat > "$CV2_DIR/config.py" << 'PYEOF'
          import os
          LOADER_DIR = os.path.dirname(os.path.abspath(__file__))
          PYTHON_EXTENSIONS_PATHS = [LOADER_DIR]
          BINARIES_PATHS = [LOADER_DIR]
          PYEOF
            cp "$CV2_DIR/config.py" "$CV2_DIR/config-3.py"
            echo "OpenCV config files created"
          fi
      - name: Generate version.json
        run: |
          VERSION="1.0.0"
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          fi
          BUILD_DATE=$(date +%Y-%m-%d)
          cat > version.json << EOF
          {
            "version": "$VERSION",
            "build_date": "$BUILD_DATE"
          }
          EOF
          echo "Generated version.json:"
          cat version.json
      - name: Prepare Release Package
        run: |
          cp backend.py dist/PeroPix/
          cp index.html dist/PeroPix/
          cp version.json dist/PeroPix/
          cp -r prompts dist/PeroPix/
          cp -r assets dist/PeroPix/
          cp -r scripts dist/PeroPix/
          cp -r data dist/PeroPix/
          cp -r local_engine dist/PeroPix/
          mkdir -p dist/PeroPix/models/censor
          cp models/censor/* dist/PeroPix/models/censor/
          mkdir -p dist/PeroPix/models/checkpoints
          mkdir -p dist/PeroPix/models/loras
          mkdir -p dist/PeroPix/models/upscale_models
          mkdir -p dist/PeroPix/outputs
          mkdir -p dist/PeroPix/presets
          cp README.md dist/PeroPix/ 2>/dev/null || true
          cp LICENSE dist/PeroPix/ 2>/dev/null || true
      - name: Create Launcher Script
        run: |
          cat > dist/PeroPix/PeroPix.command << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          echo "Starting PeroPix..."
          open "http://127.0.0.1:8765"
          ./python/bin/python3 backend.py
          EOF
          chmod +x dist/PeroPix/PeroPix.command
      - name: Create ZIP Archive
        run: |
          cd dist
          zip -r ../PeroPix-macOS.zip PeroPix
      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: PeroPix-macOS.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Build Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: PeroPix-macOS
          path: PeroPix-macOS.zip
          retention-days: 7


