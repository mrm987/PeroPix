name: Notify Discord

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'ì•Œë¦¼í•  í”Œë«í¼ (windows, macos, both)'
        required: true
        default: 'both'
        type: choice
        options:
          - windows
          - macos
          - both

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get Latest Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE=$(gh api repos/${{ github.repository }}/releases/latest)
          # tag_nameì—ì„œ ìˆœìˆ˜ íƒœê·¸ë§Œ ì¶”ì¶œ (ì˜ˆ: "v1.0.9: some message" -> "v1.0.9")
          RAW_TAG=$(echo $RELEASE | jq -r '.tag_name')
          CLEAN_TAG=$(echo "$RAW_TAG" | sed 's/:.*//; s/ .*//')
          echo "tag=$CLEAN_TAG" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE" | jq -r '.body // ""' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          TAG_NAME: ${{ steps.release.outputs.tag }}
          RELEASE_BODY: ${{ steps.release.outputs.body }}
          PLATFORMS: ${{ inputs.platforms }}
        run: |
          WIN_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/PeroPix-Windows.zip"
          MAC_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/PeroPix-macOS.zip"
          
          # í”Œë«í¼ì— ë”°ë¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
          if [ "$PLATFORMS" = "windows" ]; then
            DOWNLOADS="ğŸ“¥ [Windows](${WIN_URL})"
          elif [ "$PLATFORMS" = "macos" ]; then
            DOWNLOADS="ğŸ“¥ [macOS](${MAC_URL})"
          else
            DOWNLOADS="ğŸ“¥ [Windows](${WIN_URL}) | [macOS](${MAC_URL})"
          fi
          
          jq -n \
            --arg tag "$TAG_NAME" \
            --arg body "$RELEASE_BODY" \
            --arg downloads "$DOWNLOADS" \
            '{content: "ğŸš€ **\($tag)** ë¦´ë¦¬ì¦ˆ!\n\n\($body)\n\n\($downloads)"}' \
          | curl -H "Content-Type: application/json" -d @- $DISCORD_WEBHOOK
