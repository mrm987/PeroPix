name: Build and Release
on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Embedded Python
        shell: pwsh
        run: |
          $pythonUrl = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          Invoke-WebRequest -Uri $pythonUrl -OutFile python-embed.zip
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/python"
          Expand-Archive -Path python-embed.zip -DestinationPath "dist/PeroPix/python"
          $pthFile = "dist/PeroPix/python/python311._pth"
          $content = Get-Content $pthFile
          $content = $content -replace '#import site', 'import site'
          Set-Content $pthFile $content
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & "dist/PeroPix/python/python.exe" get-pip.py --no-warn-script-location
      - name: Install Dependencies
        shell: pwsh
        run: |
          $pythonExe = "dist/PeroPix/python/python.exe"
          & $pythonExe -m pip install --no-warn-script-location -r requirements-core.txt
      - name: Prepare Release Package
        shell: pwsh
        run: |
          Copy-Item "backend.py" -Destination "dist/PeroPix/"
          Copy-Item "index.html" -Destination "dist/PeroPix/"
          Copy-Item "PeroPix.bat" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "prompts" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "assets" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "scripts" -Destination "dist/PeroPix/"
          Copy-Item -Recurse "models/censor" -Destination "dist/PeroPix/models/"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/checkpoints"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/loras"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/upscale_models"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/outputs"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/presets"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/data"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/censoring/uncensored"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/censoring/censored"
          Copy-Item "README.md" -Destination "dist/PeroPix/" -ErrorAction SilentlyContinue
      - name: Create ZIP Archive
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/PeroPix/*" -DestinationPath "PeroPix-Windows.zip"
      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: PeroPix-Windows.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Build Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: PeroPix-Windows
          path: PeroPix-Windows.zip
          retention-days: 7

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Create Package Structure
        run: |
          mkdir -p dist/PeroPix/python
          curl -L -o python.tar.gz "https://github.com/indygreg/python-build-standalone/releases/download/20240415/cpython-3.11.9+20240415-aarch64-apple-darwin-install_only.tar.gz"
          tar -xzf python.tar.gz -C dist/PeroPix/python --strip-components=1
      - name: Install Dependencies
        run: |
          dist/PeroPix/python/bin/python3 -m pip install --upgrade pip
          dist/PeroPix/python/bin/python3 -m pip install -r requirements-core.txt
      - name: Prepare Release Package
        run: |
          cp backend.py dist/PeroPix/
          cp index.html dist/PeroPix/
          cp -r prompts dist/PeroPix/
          cp -r assets dist/PeroPix/
          cp -r scripts dist/PeroPix/
          cp -r models/censor dist/PeroPix/models/
          mkdir -p dist/PeroPix/models/checkpoints
          mkdir -p dist/PeroPix/models/loras
          mkdir -p dist/PeroPix/models/upscale_models
          mkdir -p dist/PeroPix/outputs
          mkdir -p dist/PeroPix/presets
          mkdir -p dist/PeroPix/data
          mkdir -p dist/PeroPix/censoring/uncensored
          mkdir -p dist/PeroPix/censoring/censored
          cp README.md dist/PeroPix/ 2>/dev/null || true
      - name: Create Launcher Script
        run: |
          cat > dist/PeroPix/PeroPix.command << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          echo "Starting PeroPix..."
          open "http://127.0.0.1:8765"
          ./python/bin/python3 backend.py
          EOF
          chmod +x dist/PeroPix/PeroPix.command
      - name: Create ZIP Archive
        run: |
          cd dist
          zip -r ../PeroPix-macOS.zip PeroPix
      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: PeroPix-macOS.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Build Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: PeroPix-macOS
          path: PeroPix-macOS.zip
          retention-days: 7

  notify-discord:
    needs: [build-windows, build-macos]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          RELEASE_BODY: ${{ github.event.release.body }}
          TAG_NAME: ${{ github.event.release.tag_name }}
        run: |
          jq -n \
            --arg tag "$TAG_NAME" \
            --arg body "$RELEASE_BODY" \
            --arg win "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/PeroPix-Windows.zip" \
            --arg mac "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/PeroPix-macOS.zip" \
            '{content: "ðŸš€ **\($tag)** ë¦´ë¦¬ì¦ˆ!\n\n\($body)\n\nðŸ“¥ [Windows](\($win)) | [macOS](\($mac))"}' \
          | curl -H "Content-Type: application/json" -d @- $DISCORD_WEBHOOK
