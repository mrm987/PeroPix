name: Build and Release

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Embedded Python
        shell: pwsh
        run: |
          # Python embeddable 다운로드
          $pythonUrl = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          Invoke-WebRequest -Uri $pythonUrl -OutFile python-embed.zip

          # 압축 해제
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/python"
          Expand-Archive -Path python-embed.zip -DestinationPath "dist/PeroPix/python"

          # pip 설치를 위해 python311._pth 수정
          $pthFile = "dist/PeroPix/python/python311._pth"
          $content = Get-Content $pthFile
          $content = $content -replace '#import site', 'import site'
          Set-Content $pthFile $content

          # get-pip.py 다운로드 및 실행
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & "dist/PeroPix/python/python.exe" get-pip.py --no-warn-script-location

      - name: Install Dependencies
        shell: pwsh
        run: |
          $pythonExe = "dist/PeroPix/python/python.exe"
          & $pythonExe -m pip install --no-warn-script-location fastapi uvicorn httpx pillow numpy pydantic aiofiles

      - name: Prepare Release Package
        shell: pwsh
        run: |
          # 앱 파일 복사
          Copy-Item "backend.py" -Destination "dist/PeroPix/"
          Copy-Item "index.html" -Destination "dist/PeroPix/"

          # prompts 폴더 복사
          Copy-Item -Recurse "prompts" -Destination "dist/PeroPix/"

          # assets 폴더 복사
          Copy-Item -Recurse "assets" -Destination "dist/PeroPix/"

          # 빈 폴더 생성
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/checkpoints"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/loras"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/models/upscale_models"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/outputs"
          New-Item -ItemType Directory -Force -Path "dist/PeroPix/presets"

          # README 복사
          Copy-Item "README.md" -Destination "dist/PeroPix/" -ErrorAction SilentlyContinue

      - name: Create Launcher Script
        shell: pwsh
        run: |
          # PeroPix.bat 생성
          $bat = "@echo off`r`ntitle PeroPix`r`ncd /d `"%~dp0`"`r`necho Starting PeroPix...`r`nstart `"`" `"http://127.0.0.1:8765`"`r`npython\python.exe backend.py"
          [System.IO.File]::WriteAllText("dist/PeroPix/PeroPix.bat", $bat)

      - name: Create ZIP Archive
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/PeroPix/*" -DestinationPath "PeroPix-Windows.zip"

      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: PeroPix-Windows.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: PeroPix-Windows
          path: PeroPix-Windows.zip
          retention-days: 7
