name: Build macOS

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create Package Structure
        run: |
          mkdir -p dist/PeroPix/python

          # Python standalone 다운로드 (universal2 for Intel + Apple Silicon)
          curl -L -o python.tar.gz "https://github.com/indygreg/python-build-standalone/releases/download/20240415/cpython-3.11.9+20240415-aarch64-apple-darwin-install_only.tar.gz"
          tar -xzf python.tar.gz -C dist/PeroPix/python --strip-components=1

      - name: Install Dependencies
        run: |
          dist/PeroPix/python/bin/python3 -m pip install --upgrade pip
          dist/PeroPix/python/bin/python3 -m pip install fastapi uvicorn httpx pillow numpy pydantic aiofiles

      - name: Prepare Release Package
        run: |
          # 앱 파일 복사
          cp backend.py dist/PeroPix/
          cp index.html dist/PeroPix/

          # prompts 폴더 복사
          cp -r prompts dist/PeroPix/

          # assets 폴더 복사
          cp -r assets dist/PeroPix/

          # 빈 폴더 생성
          mkdir -p dist/PeroPix/models/checkpoints
          mkdir -p dist/PeroPix/models/loras
          mkdir -p dist/PeroPix/models/upscale_models
          mkdir -p dist/PeroPix/outputs
          mkdir -p dist/PeroPix/presets

          # README 복사
          cp README.md dist/PeroPix/ 2>/dev/null || true

      - name: Create Launcher Script
        run: |
          cat > dist/PeroPix/PeroPix.command << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          echo "Starting PeroPix..."
          open "http://127.0.0.1:8765"
          ./python/bin/python3 backend.py
          EOF
          chmod +x dist/PeroPix/PeroPix.command

      - name: Create ZIP Archive
        run: |
          cd dist
          zip -r ../PeroPix-macOS.zip PeroPix

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PeroPix-macOS
          path: PeroPix-macOS.zip
          retention-days: 7
